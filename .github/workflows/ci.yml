name: Deploy to Vercel

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  actions: read
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Identify affected apps
        id: affected
        run: |
          apps=$(npx nx affected:apps --base=origin/main --head=HEAD --plain)
          echo "::set-output name=apps::$apps"

      - name: Deploy affected apps to Vercel
        if: steps.affected_apps.outputs.apps != ''
        run: |
          for app in ${{ steps.affected_apps.outputs.apps }}; do
            if [ "$app" == "my-new-app" ]; then
              echo "Deploying my-new-app to Vercel..."
              vercel --prod --token ${{ secrets.VERCEL_TOKEN }} --project prj_BXqjbtiNcJVZIPbnMeJCtBrUwyo7  
            elif [ "$app" == "app2" ]; then
              echo "Deploying app2 to Vercel..."
              vercel --prod --token ${{ secrets.VERCEL_TOKEN }} --project prj_VrAFQ4xnmp1KdkuNeKwYusuXeAva  
            fi
          done
